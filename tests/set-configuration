# This test verifies that the client can deploy a cluster configuration
# via the controller.

# @TEST-REQUIRES: $SCRIPTS/docker-requirements
# @TEST-EXEC: bash %INPUT
# @TEST-EXEC: btest-diff output

. $SCRIPTS/docker-setup

docker_populate singlehost
docker_compose_up

# The Zeek host now runs a controller. Run an agent alongside it.
docker_exec controller mkdir /tmp/agent
docker_exec -d -w /tmp/agent -- controller zeek -j site/testing/agent.zeek \
    Management::Agent::name=instance-1 \
    Broker::default_port=10000/tcp

zeek_client set-config - <<EOF
[instances]
instance-1 = 127.0.0.1:2151

[manager]
instance = instance-1
port = 5000
role = manager

[logger-01]
instance = instance-1
port = 5001
role = logger

[worker-01]
instance = instance-1
role = worker
interface = eth0

[worker-02]
instance = instance-1
role = worker
interface = lo
EOF

# Retrieve the cluster nodes and strip the PIDs, since they
# change from run to run.
zeek_client get-nodes | jq 'del(.[][].pid)' >output
